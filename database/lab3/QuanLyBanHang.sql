--Ten: Pham Le Dang Kha
--MSSV: 23520669

--QUAN LY BAN HANG
CREATE DATABASE QuanLyBanHang
USE QuanLyBanHang
GO
CREATE TABLE KHACHHANG
(
	MAKH CHAR(4),
	HOTEN VARCHAR(40),
	DCHI VARCHAR(50),
	SODT VARCHAR(20),
	NGSINH SMALLDATETIME,
	NGDK SMALLDATETIME,
	DOANHSO MONEY
)

ALTER TABLE KHACHHANG
ALTER COLUMN MAKH CHAR(4) NOT NULL;

ALTER TABLE KHACHHANG ADD
CONSTRAINT PK_KH PRIMARY KEY (MAKH)

CREATE TABLE NHANVIEN
(
	MANV CHAR(4) NOT NULL,
	HOTEN VARCHAR(40),
	SODT VARCHAR (20),
	NGVL SMALLDATETIME
)

ALTER TABLE NHANVIEN ADD
CONSTRAINT PK_NV PRIMARY KEY (MANV)

CREATE TABLE SANPHAM
(
	MASP CHAR(4) NOT NULL,
	TENSP VARCHAR(40),
	DVT VARCHAR(20),
	NUOCSX VARCHAR(40),
	GIA MONEY
)

CREATE TABLE HOADON
(
	SOHD INT,
	NGHD SMALLDATETIME,
	MAKH CHAR(4),
	MANV CHAR(4),
	TRIGIA MONEY,
)

CREATE TABLE CTHD
(
	SOHD INT,
	MASP CHAR(4),
	SL INT,
)

ALTER TABLE HOADON
ALTER COLUMN SOHD INT NOT NULL;

ALTER TABLE SANPHAM ADD
CONSTRAINT PK_SP PRIMARY KEY (MASP)

ALTER TABLE HOADON ADD
CONSTRAINT PK_HD PRIMARY KEY (SOHD)



ALTER TABLE CTHD ADD
CONSTRAINT FK_CTHD_HD FOREIGN KEY (SOHD) REFERENCES HOADON(SOHD),
CONSTRAINT FK_CTHD_SP FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)

ALTER TABLE CTHD
ALTER COLUMN SOHD INT NOT NULL;

ALTER TABLE CTHD
ALTER COLUMN MASP CHAR(4) NOT NULL;

ALTER TABLE CTHD ADD
CONSTRAINT PK_CTHD PRIMARY KEY (SOHD,MASP)

ALTER TABLE HOADON ADD
CONSTRAINT FK_HD_KH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),
CONSTRAINT FK_HD_NV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)

ALTER TABLE SANPHAM
ADD GHICHU VARCHAR(20)

ALTER TABLE KHACHHANG
ADD LOAIKH TINYINT

ALTER TABLE SANPHAM
ALTER COLUMN GHICHU VARCHAR(100)

ALTER TABLE SANPHAM
DROP COLUMN GHICHU

--Cau 6
ALTER TABLE KHACHHANG
ALTER COLUMN LOAIKH VARCHAR(20)

ALTER TABLE KHACHHANG
ADD CONSTRAINT CK_LOAIKH CHECK (LOAIKH IN ('Vang lai', 'Thuong xuyen', 'Vip'))

--Cau 7
ALTER TABLE SANPHAM
ADD CONSTRAINT CK_DVT CHECK (DVT IN ('cay','hop','cai','quyen','chuc'));

--Cau 8
ALTER TABLE SANPHAM
ADD CONSTRAINT CK_GIA CHECK (GIA >= 500);

ALTER TABLE CTHD
ADD CONSTRAINT CK_SL CHECK (SL >= 1);

ALTER TABLE KHACHHANG
ADD CONSTRAINT CK_NGDK_NGSINH CHECK (NGDK > NGSINH);

--Quan Ly Giao Vu
CREATE DATABASE QUANLYGIAOVU
USE QUANLYGIAOVU
GO

CREATE TABLE KHOA
(
	MAKHOA VARCHAR(4) NOT NULL,
	TENKHOA VARCHAR(40),
	NGTLAP SMALLDATETIME,
	TRGKHOA CHAR(4),
	CONSTRAINT PK_KHOA PRIMARY KEY (MAKHOA)
)

CREATE TABLE MONHOC
(
	MAMH VARCHAR(10) NOT NULL,
	TENMH VARCHAR(40) NOT NULL,
	TCLT TINYINT,
	TCTH TINYINT,
	MAKHOA VARCHAR(4)
	CONSTRAINT PK_MH PRIMARY KEY (MAMH),
	CONSTRAINT FK_MH_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
)

CREATE TABLE DIEUKIEN
(
	MAMH VARCHAR(10) NOT NULL,
	MAMH_TRUOC VARCHAR(10) NOT NULL,
	CONSTRAINT PK_DK PRIMARY KEY (MAMH,MAMH_TRUOC),
	CONSTRAINT FK_DK1 FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),
	CONSTRAINT FK_DK2 FOREIGN KEY (MAMH_TRUOC) REFERENCES MONHOC(MAMH)
)

CREATE TABLE GIAOVIEN
(
	MAGV CHAR(4) NOT NULL,
	HOTEN VARCHAR(40),
	HOCVI VARCHAR(10),
	HOCHAM VARCHAR(10),
	GIOITINH VARCHAR(3),
	NGSINH SMALLDATETIME,
	NGVL SMALLDATETIME,
	HESO NUMERIC(4,2),
	MUCLUONG MONEY,
	MAKHOA VARCHAR(4),
	CONSTRAINT PK_GV PRIMARY KEY (MAGV),
	CONSTRAINT FK_GV_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)
)

ALTER TABLE KHOA
ADD CONSTRAINT FK_TRUONGKHOA FOREIGN KEY (TRGKHOA) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE DIEUKIEN
ADD CONSTRAINT FK_DK1 FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

ALTER TABLE DIEUKIEN
ADD CONSTRAINT FK_DK2 FOREIGN KEY (MAMH_TRUOC) REFERENCES MONHOC(MAMH)

CREATE TABLE HOCVIEN
(
	MAHV CHAR(5) NOT NULL,
	HO VARCHAR(40),
	TEN VARCHAR(10),
	NGSINH SMALLDATETIME,
	GIOITINH VARCHAR(3),
	NOISINH VARCHAR(40),
	MALOP CHAR(3),
	CONSTRAINT PK_HV PRIMARY KEY (MAHV)
)

CREATE TABLE LOP
(
	MALOP CHAR(3) NOT NULL,
	TENLOP VARCHAR(40),
	TRGLOP CHAR(5),
	SISO TINYINT,
	MAGVCN CHAR(4),
	CONSTRAINT PK_LOP PRIMARY KEY (MALOP),
	CONSTRAINT FR_LOP_GV FOREIGN KEY (MAGVCN) REFERENCES GIAOVIEN(MAGV),
	CONSTRAINT FR_LOP_HV FOREIGN KEY (TRGLOP) REFERENCES HOCVIEN(MAHV)
)

ALTER TABLE HOCVIEN
ADD CONSTRAINT FK_HV_LOP FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)

CREATE TABLE GIANGDAY
(
	MALOP CHAR(3) NOT NULL,
	MAMH VARCHAR(10) NOT NULL,
	MAGV CHAR(4),
	HOCKY TINYINT,
	NAM SMALLINT,
	TUNGAY SMALLDATETIME,
	DENNGAY SMALLDATETIME,
	CONSTRAINT PK_GD PRIMARY KEY (MALOP, MAMH),
	CONSTRAINT FK_GD_LOP FOREIGN KEY (MALOP) REFERENCES LOP(MALOP),
	CONSTRAINT FK_GD_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),
	CONSTRAINT FK_GD_GV FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV)
)

CREATE TABLE KETQUATHI
(
	MAHV CHAR(5) NOT NULL,
	MAMH VARCHAR(10) NOT NULL,
	LANTHI TINYINT NOT NULL,
	NGTHI SMALLDATETIME,
	DIEM NUMERIC (4,2),
	KQUA VARCHAR(10),
	CONSTRAINT PK_KQT PRIMARY KEY (MAHV,MAMH,LANTHI),
	CONSTRAINT FK_KQT_HV FOREIGN KEY (MAHV) REFERENCES HOCVIEN(MAHV),
	CONSTRAINT FK_KQT_MH FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)
)

ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_GT CHECK (GIOITINH IN ('NAM', 'NU'));

ALTER TABLE KETQUATHI
ADD CONSTRAINT CK_DIEM CHECK (DIEM >= 0 AND DIEM <= 10);

ALTER TABLE KETQUATHI
ADD CONSTRAINT CK_LANTHI CHECK (LANTHI > 0 AND LANTHI <= 3);

ALTER TABLE GIANGDAY
ADD CONSTRAINT CK_HK CHECK (HOCKY >=1 AND HOCKY <= 3);

ALTER TABLE GIAOVIEN
ADD CONSTRAINT CK_HOCVI CHECK (HOCVI IN ('CN','KS','Ths','TS','PTS'));

CREATE TRIGGER trg_updateketqua
ON KETQUATHI
AFTER INSERT, UPDATE
AS
BEGIN
	UPDATE KETQUATHI
	SET KQUA = CASE
				WHEN KETQUATHI.DIEM >= 5 THEN 'DAT'
				ELSE 'KHONG DAT'
				END
		FROM inserted
		WHERE KETQUATHI.MAHV = inserted.MAHV
		AND KETQUATHI.MAMH = inserted.MAMH
		AND KETQUATHI.LANTHI = inserted.LANTHI;
		END;

--Buoi 2

--NHAP DU LIEU QUAN LY BAN HANG
SET DATEFORMAT DMY
INSERT INTO NHANVIEN VALUES ('NV01','Nguyen Nhu Nhut','927345678','13/4/2006')
INSERT INTO NHANVIEN VALUES ('NV02','Le Thi Phi Yen','987567390','21/4/2006')
INSERT INTO NHANVIEN VALUES ('NV03','Nguyen Van B','997047382','27/4/2006')
INSERT INTO NHANVIEN VALUES ('NV04','Ngo Thanh Tuan','913758498','24/6/2006')
INSERT INTO NHANVIEN VALUES ('NV05','Nguyen Thi Truc Thanh','918590387','20/7/2006')

SELECT * FROM NHANVIEN




INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES  ('KH01','Nguyen Van A','731 Tran Hung Dao, Q5, TpHCM','8823451','22/10/1960','13060000', '22/07/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH02','Tran Ngoc Han','23/5 Nguyen Trai, Q5, TpHCM','908256478','3/4/1974','280000', '30/07/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH03','Tran Ngoc Linh','45 Nguyen Canh Chan, Q1, TpHCM','938776266','12/6/1980','3860000', '05/08/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH04','Tran Minh Long','50/34 Le Dai Hanh, Q10, TpHCM','917325476','9/3/1965','250000', '02/10/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH05','Le Nhat Minh','34 Truong Dinh, Q3, TpHCM','8246108','10/3/1950','21000', '28/10/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH06','Le Hoai Thuong','227 Nguyen Van Cu, Q5, TpHCM','8631738','31/12/1981','915000', '24/11/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH07','Nguyen Van Tam','32/3 Tran Binh Trong, Q5, TpHCM','916783565','6/4/1971','12500', '01/12/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH08','Phan Thi Thanh','45/2 An Duong Vuong, Q5, TpHCM','938435756','10/1/1971','365000', '13/12/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH09','Le Ha Vinh','873 Le Hong Phong, Q5, TpHCM','8654763','3/9/1979','70000', '14/01/2007')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES ('KH10','Ha Duy Lap','34/34B Nguyen Trai, Q1, TpHCM','8768904','2/5/1983','67500', '16/01/2007')

DELETE FROM SANPHAM

INSERT INTO SANPHAM VALUES ('BC01','But chi','cay','Singapore','3000')
INSERT INTO SANPHAM VALUES ('BC02','But chi','cay','Singapore','5000')
INSERT INTO SANPHAM VALUES ('BC03','But chi','cay','Viet Nam','3500')
INSERT INTO SANPHAM VALUES ('BC04','But chi','hop','Viet Nam','30000')
INSERT INTO SANPHAM VALUES ('BB01','But bi','cay','Viet Nam','5000')
INSERT INTO SANPHAM VALUES ('BB02','But bi','cay','Trung Quoc','7000')
INSERT INTO SANPHAM VALUES ('BB03','But bi','hop','Thai Lan','100000')
INSERT INTO SANPHAM VALUES ('TV01','Tap 100 giay mong','quyen','Trung Quoc','2500')
INSERT INTO SANPHAM VALUES ('TV02','Tap 200 giay mong','quyen','Trung Quoc','4500')
INSERT INTO SANPHAM VALUES ('TV03','Tap 100 giay tot','quyen','Viet Nam','3000')
INSERT INTO SANPHAM VALUES ('TV04','Tap 200 giay tot','quyen','Viet Nam','5500')
INSERT INTO SANPHAM VALUES ('TV05','Tap 100 trang','chuc','Viet Nam','23000')
INSERT INTO SANPHAM VALUES ('TV06','Tap 200 trang','chuc','Viet Nam','53000')
INSERT INTO SANPHAM VALUES ('TV07','Tap 100 trang','chuc','Trung Quoc','34000')
INSERT INTO SANPHAM VALUES ('ST01','So tay 500 trang','quyen','Trung Quoc','40000')
INSERT INTO SANPHAM VALUES ('ST02','So tay loai 1','quyen','Viet Nam','55000')
INSERT INTO SANPHAM VALUES ('ST03','So tay loai 2','quyen','Viet Nam','51000')
INSERT INTO SANPHAM VALUES ('ST04','So tay','quyen','Thai Lan','55000')
INSERT INTO SANPHAM VALUES ('ST05','So tay mong','quyen','Thai Lan','20000')
INSERT INTO SANPHAM VALUES ('ST06','Phan viet bang','hop','Viet Nam','5000')
INSERT INTO SANPHAM VALUES ('ST07','Phan khong bui','hop','Viet Nam','7000')
INSERT INTO SANPHAM VALUES ('ST08','Bong bang','cai','Viet Nam','1000')
INSERT INTO SANPHAM VALUES ('ST09','But long','cay','Viet Nam','5000')
INSERT INTO SANPHAM VALUES ('ST10','But long','cay','Trung Quoc','7000')

DELETE FROM HOADON

INSERT INTO HOADON VALUES ('1001','23/07/2006','KH01','NV01','320000')
INSERT INTO HOADON VALUES ('1002','12/08/2006','KH01','NV02','840000')
INSERT INTO HOADON VALUES ('1003','23/08/2006','KH02','NV01','100000')
INSERT INTO HOADON VALUES ('1004','01/09/2006','KH02','NV01','180000')
INSERT INTO HOADON VALUES ('1005','20/10/2006','KH01','NV02','3800000')
INSERT INTO HOADON VALUES ('1006','16/10/2006','KH01','NV03','2430000')
INSERT INTO HOADON VALUES ('1007','28/10/2006','KH03','NV03','510000')
INSERT INTO HOADON VALUES ('1008','28/10/2006','KH01','NV03','440000')
INSERT INTO HOADON VALUES ('1009','28/10/2006','KH03','NV04','200000')
INSERT INTO HOADON VALUES ('1010','01/11/2006','KH01','NV01','5200000')
INSERT INTO HOADON VALUES ('1011','04/11/2006','KH04','NV03','250000')
INSERT INTO HOADON VALUES ('1012','30/11/2006','KH05','NV03','21000')
INSERT INTO HOADON VALUES ('1013','12/12/2006','KH06','NV01','5000')
INSERT INTO HOADON VALUES ('1014','31/12/2006','KH03','NV02','3150000')
INSERT INTO HOADON VALUES ('1015','01/01/2007','KH06','NV01','910000')
INSERT INTO HOADON VALUES ('1016','01/01/2007','KH07','NV02','12500')
INSERT INTO HOADON VALUES ('1017','02/01/2007','KH08','NV03','35000')
INSERT INTO HOADON VALUES ('1018','13/01/2007','KH08','NV03','330000')
INSERT INTO HOADON VALUES ('1019','13/01/2007','KH01','NV03','30000')
INSERT INTO HOADON VALUES ('1020','14/01/2007','KH09','NV04','70000')
INSERT INTO HOADON VALUES ('1021','16/01/2007','KH10','NV03','67500')
INSERT INTO HOADON VALUES ('1022','16/01/2007',Null,'NV03','7000')
INSERT INTO HOADON VALUES ('1023','17/01/2007',Null,'NV01','330000')


INSERT INTO CTHD VALUES ('1001','TV02','10')
INSERT INTO CTHD VALUES ('1001','ST01','5')
INSERT INTO CTHD VALUES ('1001','BC01','5')
INSERT INTO CTHD VALUES ('1001','BC02','10')
INSERT INTO CTHD VALUES ('1001','ST08','10')
INSERT INTO CTHD VALUES ('1002','BC04','20')
INSERT INTO CTHD VALUES ('1002','BB01','20')
INSERT INTO CTHD VALUES ('1002','BB02','20')
INSERT INTO CTHD VALUES ('1003','BB03','10')
INSERT INTO CTHD VALUES ('1004','TV01','20')
INSERT INTO CTHD VALUES ('1004','TV02','10')
INSERT INTO CTHD VALUES ('1004','TV03','10')
INSERT INTO CTHD VALUES ('1004','TV04','10')
INSERT INTO CTHD VALUES ('1005','TV05','50')
INSERT INTO CTHD VALUES ('1005','TV06','50')
INSERT INTO CTHD VALUES ('1006','TV07','20')
INSERT INTO CTHD VALUES ('1006','ST01','30')
INSERT INTO CTHD VALUES ('1006','ST02','10')
INSERT INTO CTHD VALUES ('1007','ST03','10')
INSERT INTO CTHD VALUES ('1008','ST04','8')
INSERT INTO CTHD VALUES ('1009','ST05','10')
INSERT INTO CTHD VALUES ('1010','TV07','50')
INSERT INTO CTHD VALUES ('1010','ST07','50')
INSERT INTO CTHD VALUES ('1010','ST08','100')
INSERT INTO CTHD VALUES ('1010','ST04','50')
INSERT INTO CTHD VALUES ('1010','TV03','100')
INSERT INTO CTHD VALUES ('1011','ST06','50')
INSERT INTO CTHD VALUES ('1012','ST07','3')
INSERT INTO CTHD VALUES ('1013','ST08','5')
INSERT INTO CTHD VALUES ('1014','BC02','80')
INSERT INTO CTHD VALUES ('1014','BB02','100')
INSERT INTO CTHD VALUES ('1014','BC04','60')
INSERT INTO CTHD VALUES ('1014','BB01','50')
INSERT INTO CTHD VALUES ('1015','BB02','30')
INSERT INTO CTHD VALUES ('1015','BB03','7')
INSERT INTO CTHD VALUES ('1016','TV01','5')
INSERT INTO CTHD VALUES ('1017','TV02','1')
INSERT INTO CTHD VALUES ('1017','TV03','1')
INSERT INTO CTHD VALUES ('1017','TV04','5')
INSERT INTO CTHD VALUES ('1018','ST04','6')
INSERT INTO CTHD VALUES ('1019','ST05','1')
INSERT INTO CTHD VALUES ('1019','ST06','2')
INSERT INTO CTHD VALUES ('1020','ST07','10')
INSERT INTO CTHD VALUES ('1021','ST08','5')
INSERT INTO CTHD VALUES ('1021','TV01','7')
INSERT INTO CTHD VALUES ('1021','TV02','10')
INSERT INTO CTHD VALUES ('1022','ST07','1')
INSERT INTO CTHD VALUES ('1023','ST04','6')

--NHAP DU LIEU QUAN LY GIAO VU

ALTER TABLE KHOA
NOCHECK CONSTRAINT FK_TRUONGKHOA

ALTER TABLE LOP
NOCHECK CONSTRAINT FR_LOP_GV, FR_LOP_HV 

ALTER TABLE MONHOC
NOCHECK CONSTRAINT FK_MH_KHOA

ALTER TABLE GIANGDAY
NOCHECK CONSTRAINT FK_GD_GV, FK_GD_LOP, FK_GD_MH

ALTER TABLE GIAOVIEN
NOCHECK CONSTRAINT FK_GV_KHOA

ALTER TABLE DIEUKIEN
NOCHECK CONSTRAINT FK_DK1, FK_DK2

ALTER TABLE KETQUATHI
NOCHECK CONSTRAINT FK_KQT_HV, FK_KQT_MH

ALTER TABLE HOCVIEN
NOCHECK CONSTRAINT FK_HV_LOP


INSERT INTO KHOA VALUES('KHMT','Khoa hoc may tinh','7/6/2005','GV01')
INSERT INTO KHOA VALUES('HTTT','He thong thong tin','7/6/2005','GV02')
INSERT INTO KHOA VALUES('CNPM','Cong nghe phan mem','7/6/2005','GV04')
INSERT INTO KHOA VALUES('MTT','Mang va truyen thong','20/10/2005','GV03')
INSERT INTO KHOA VALUES('KTMT','Ky thuat may tinh','20/12/2005',Null)

INSERT INTO LOP VALUES ('K11','Lop 1 khoa 1','K1108','11','GV07')
INSERT INTO LOP VALUES ('K12','Lop 2 khoa 1','K1205','12','GV09')
INSERT INTO LOP VALUES ('K13','Lop 3 khoa 1','K1305','12','GV14')


INSERT INTO MONHOC VALUES ('THDC','Tin hoc dai cuong','4','1','KHMT')
INSERT INTO MONHOC VALUES ('CTRR','Cau truc roi rac','5','0','KHMT')
INSERT INTO MONHOC VALUES ('CSDL','Co so du lieu','3','1','HTTT')
INSERT INTO MONHOC VALUES ('CTDLGT','Cau truc du lieu va giai thuat','3','1','KHMT')
INSERT INTO MONHOC VALUES ('PTTKTT','Phan tich thiet ke thuat toan','3','0','KHMT')
INSERT INTO MONHOC VALUES ('DHMT','Do hoa may tinh','3','1','KHMT')
INSERT INTO MONHOC VALUES ('KTMT','Kien truc may tinh','3','0','KTMT')
INSERT INTO MONHOC VALUES ('TKCSDL','Thiet ke co so du lieu','3','1','HTTT')
INSERT INTO MONHOC VALUES ('PTTKHTTT','Phan tich thiet ke he thong thong tin','4','1','HTTT')
INSERT INTO MONHOC VALUES ('HDH','He dieu hanh','4','0','KTMT')
INSERT INTO MONHOC VALUES ('NMCNPM','Nhap mon cong nghe phan mem','3','0','CNPM')
INSERT INTO MONHOC VALUES ('LTCFW','Lap trinh C for win','3','1','CNPM')
INSERT INTO MONHOC VALUES ('LTHDT','Lap trinh huong doi tuong','3','1','CNPM')


INSERT INTO GIANGDAY VALUES ('K11','THDC','GV07','1','2006','2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES ('K12','THDC','GV06','1','2006','2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES ('K13','THDC','GV15','1','2006','2/1/2006','12/5/2006')
INSERT INTO GIANGDAY VALUES ('K11','CTRR','GV02','1','2006','9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES ('K12','CTRR','GV02','1','2006','9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES ('K13','CTRR','GV08','1','2006','9/1/2006','17/5/2006')
INSERT INTO GIANGDAY VALUES ('K11','CSDL','GV05','2','2006','1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES ('K12','CSDL','GV09','2','2006','1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES ('K13','CTDLGT','GV15','2','2006','1/6/2006','15/7/2006')
INSERT INTO GIANGDAY VALUES ('K13','CSDL','GV05','3','2006','1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K13','DHMT','GV07','3','2006','1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K11','CTDLGT','GV15','3','2006','1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K12','CTDLGT','GV15','3','2006','1/8/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K11','HDH','GV04','1','2007','2/1/2007','18/2/2007')
INSERT INTO GIANGDAY VALUES ('K12','HDH','GV04','1','2007','2/1/2007','20/3/2007')
INSERT INTO GIANGDAY VALUES ('K11','DHMT','GV07','1','2007','18/2/2007','20/3/2007')



INSERT INTO GIAOVIEN VALUES ('GV01','Ho Thanh Son','PTS','GS','Nam','2/5/1950','11/1/2004','5','2250000','KHMT')
INSERT INTO GIAOVIEN VALUES ('GV02','Tran Tam Thanh','TS','PGS','Nam','17/12/1965','20/4/2004','4.5','2025000','HTTT')
INSERT INTO GIAOVIEN VALUES ('GV03','Do Nghiem Phung','TS','GS','Nu','1/8/1950','23/9/2004','4','1800000','CNPM')
INSERT INTO GIAOVIEN VALUES ('GV04','Tran Nam Son','TS','PGS','Nam','22/2/1961','12/1/2005','4.5','2025000','KTMT')
INSERT INTO GIAOVIEN VALUES ('GV05','Mai Thanh Danh','ThS','GV','Nam','12/3/1958','12/1/2005','3','1350000','HTTT')
INSERT INTO GIAOVIEN VALUES ('GV06','Tran Doan Hung','TS','GV','Nam','11/3/1953','12/1/2005','4.5','2025000','KHMT')
INSERT INTO GIAOVIEN VALUES ('GV07','Nguyen Minh Tien','ThS','GV','Nam','23/11/1971','1/3/2005','4','1800000','KHMT')
INSERT INTO GIAOVIEN VALUES ('GV08','Le Thi Tran','KS','Null','Nu','26/3/1974','1/3/2005','1.69','760500','KHMT')
INSERT INTO GIAOVIEN VALUES ('GV09','Nguyen To Lan','ThS','GV','Nu','31/12/1966','1/3/2005','4','1800000','HTTT')
INSERT INTO GIAOVIEN VALUES ('GV10','Le Tran Anh Loan','KS','Null','Nu','17/7/1972','1/3/2005','1.86','837000','CNPM')
INSERT INTO GIAOVIEN VALUES ('GV11','Ho Thanh Tung','CN','GV','Nam','12/1/1980','15/5/2005','2.67','1201500','MTT')
INSERT INTO GIAOVIEN VALUES ('GV12','Tran Van Anh','CN','Null','Nu','29/3/1981','15/5/2005','1.69','760500','CNPM')
INSERT INTO GIAOVIEN VALUES ('GV13','Nguyen Linh Dan','CN','Null','Nu','23/5/1980','15/5/2005','1.69','760500','KTMT')
INSERT INTO GIAOVIEN VALUES ('GV14','Truong Minh Chau','ThS','GV','Nu','30/11/1976','15/5/2005','3','1350000','MTT')
INSERT INTO GIAOVIEN VALUES ('GV15','Le Ha Thanh','ThS','GV','Nam','4/5/1978','15/5/2005','3','1350000','KHMT')


INSERT INTO DIEUKIEN VALUES ('CSDL','CTRR')
INSERT INTO DIEUKIEN VALUES ('CSDL','CTDLGT')
INSERT INTO DIEUKIEN VALUES ('CTDLGT','THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKTT','THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKTT','CTDLGT')
INSERT INTO DIEUKIEN VALUES ('DHMT','THDC')
INSERT INTO DIEUKIEN VALUES ('LTHDT','THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKHTTT','CSDL')

INSERT INTO KETQUATHI VALUES ('K1101','CSDL','1','20/7/2006','10','Dat')
INSERT INTO KETQUATHI VALUES ('K1101','CTDLGT','1','28/12/2006','9','Dat')
INSERT INTO KETQUATHI VALUES ('K1101','THDC','1','20/5/2006','9','Dat')
INSERT INTO KETQUATHI VALUES ('K1101','CTRR','1','13/5/2006','9.5','Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL','1','20/7/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL','2','27/7/2006','4.25','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL','3','10/8/2006','4.5','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT','1','28/12/2006','4.5','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT','2','5/1/2007','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT','3','15/1/2007','6','Dat')
INSERT INTO KETQUATHI VALUES ('K1102','THDC','1','20/5/2006','5','Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTRR','1','13/5/2006','7','Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CSDL','1','20/7/2006','3.5','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CSDL','2','27/7/2006','8.25','Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CTDLGT','1','28/12/2006','7','Dat')
INSERT INTO KETQUATHI VALUES ('K1103','THDC','1','20/5/2006','8','Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CTRR','1','13/5/2006','6.5','Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CSDL','1','20/7/2006','3.75','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTDLGT','1','28/12/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','THDC','1','20/5/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR','1','13/5/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR','2','20/5/2006','3.5','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR','3','30/6/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CSDL','1','20/7/2006','6','Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CTDLGT','1','28/12/2006','5','Dat')
INSERT INTO KETQUATHI VALUES ('K1201','THDC','1','20/5/2006','8.5','Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CTRR','1','13/5/2006','9','Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CSDL','1','20/7/2006','8','Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTDLGT','1','28/12/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTDLGT','2','5/1/2007','5','Dat')
INSERT INTO KETQUATHI VALUES ('K1202','THDC','1','20/5/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','THDC','2','27/5/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR','1','13/5/2006','3','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR','2','20/5/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR','3','30/6/2006','6.25','Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CSDL','1','20/7/2006','9.25','Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CTDLGT','1','28/12/2006','9.5','Dat')
INSERT INTO KETQUATHI VALUES ('K1203','THDC','1','20/5/2006','10','Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CTRR','1','13/5/2006','10','Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CSDL','1','20/7/2006','8.5','Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CTDLGT','1','28/12/2006','6.75','Dat')
INSERT INTO KETQUATHI VALUES ('K1204','THDC','1','20/5/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CTRR','1','13/5/2006','6','Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CSDL','1','20/12/2006','4.25','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CTDLGT','1','25/7/2006','8','Dat')
INSERT INTO KETQUATHI VALUES ('K1301','THDC','1','20/5/2006','7.75','Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CTRR','1','13/5/2006','8','Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CSDL','1','20/12/2006','6.75','Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CTDLGT','1','25/7/2006','5','Dat')
INSERT INTO KETQUATHI VALUES ('K1302','THDC','1','20/5/2006','8','Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CTRR','1','13/5/2006','8.5','Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CSDL','1','20/12/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT','1','25/7/2006','4.5','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT','2','7/8/2006','4','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT','3','15/8/2006','4.25','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','THDC','1','20/5/2006','4.5','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTRR','1','13/5/2006','3.25','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTRR','2','20/5/2006','5','Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CSDL','1','20/12/2006','7.75','Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CTDLGT','1','25/7/2006','9.75','Dat')
INSERT INTO KETQUATHI VALUES ('K1304','THDC','1','20/5/2006','5.5','Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CTRR','1','13/5/2006','5','Dat')
INSERT INTO KETQUATHI VALUES ('K1305','CSDL','1','20/12/2006','9.25','Dat')
INSERT INTO KETQUATHI VALUES ('K1305','CTDLGT','1','25/7/2006','10','Dat')
INSERT INTO KETQUATHI VALUES ('K1305','THDC','1','20/5/2006','8','Dat')
INSERT INTO KETQUATHI VALUES ('K1305','CTRR','1','13/5/2006','10','Dat')

INSERT INTO HOCVIEN VALUES ('K1101','Nguyen Van','A','27/1/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN VALUES ('K1102','Tran Ngoc','Han','14/3/1986','Nu','Kien Giang','K11')
INSERT INTO HOCVIEN VALUES ('K1103','Ha Duy','Lap','18/4/1986','Nam','Nghe An','K11')
INSERT INTO HOCVIEN VALUES ('K1104','Tran Ngoc','Linh','30/3/1986','Nu','Tay Ninh','K11')
INSERT INTO HOCVIEN VALUES ('K1105','Tran Minh','Long','27/2/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN VALUES ('K1106','Le Nhat','Minh','24/1/1986','Nam','TpHCM','K11')
INSERT INTO HOCVIEN VALUES ('K1107','Nguyen Nhu','Nhut','27/1/1986','Nam','Ha Noi','K11')
INSERT INTO HOCVIEN VALUES ('K1108','Nguyen Manh','Tam','27/2/1986','Nam','Kien Giang','K11')
INSERT INTO HOCVIEN VALUES ('K1109','Phan Thi Thanh','Tam','27/1/1986','Nu','Vinh Long','K11')
INSERT INTO HOCVIEN VALUES ('K1110','Le Hoai','Thuong','5/2/1986','Nu','Can Tho','K11')
INSERT INTO HOCVIEN VALUES ('K1111','Le Ha','Vinh','25/12/1986','Nam','Vinh Long','K11')
INSERT INTO HOCVIEN VALUES ('K1201','Nguyen Van','B','11/2/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1202','Nguyen Thi Kim','Duyen','18/1/1986','Nu','TpHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1203','Tran Thi Kim','Duyen','17/9/1986','Nu','TpHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1204','Truong My','Hanh','19/5/1986','Nu','Dong Nai','K12')
INSERT INTO HOCVIEN VALUES ('K1205','Nguyen Thanh','Nam','17/4/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1206','Nguyen Thi Truc','Thanh','4/3/1986','Nu','Kien Giang','K12')
INSERT INTO HOCVIEN VALUES ('K1207','Tran Thi Bich','Thuy','8/2/1986','Nu','Nghe An','K12')
INSERT INTO HOCVIEN VALUES ('K1208','Huynh Thi Kim','Trieu','8/4/1986','Nu','Tay Ninh','K12')
INSERT INTO HOCVIEN VALUES ('K1209','Pham Thanh','Trieu','23/2/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1210','Ngo Thanh','Tuan','14/2/1986','Nam','TpHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1211','Do Thi','Xuan','9/3/1986','Nu','Ha Noi','K12')
INSERT INTO HOCVIEN VALUES ('K1212','Le Thi Phi','Yen','12/3/1986','Nu','TpHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1301','Nguyen Thi Kim','Cuc','9/6/1986','Nu','Kien Giang','K13')
INSERT INTO HOCVIEN VALUES ('K1302','Truong Thi My','Hien','18/3/1986','Nu','Nghe An','K13')
INSERT INTO HOCVIEN VALUES ('K1303','Le Duc','Hien','21/3/1986','Nam','Tay Ninh','K13')
INSERT INTO HOCVIEN VALUES ('K1304','Le Quang','Hien','18/4/1986','Nam','TpHCM','K13')
INSERT INTO HOCVIEN VALUES ('K1305','Le Thi','Huong','27/3/1986','Nu','TpHCM','K13')
INSERT INTO HOCVIEN VALUES ('K1306','Nguyen Thai','Huu','30/3/1986','Nam','Ha Noi','K13')
INSERT INTO HOCVIEN VALUES ('K1307','Tran Minh','Man','28/5/1986','Nam','TpHCM','K13')
INSERT INTO HOCVIEN VALUES ('K1308','Nguyen Hieu','Nghia','8/4/1986','Nam','Kien Giang','K13')
INSERT INTO HOCVIEN VALUES ('K1309','Nguyen Trung','Nghia','18/1/1987','Nam','Nghe An','K13')
INSERT INTO HOCVIEN VALUES ('K1310','Tran Thi Hong','Tham','22/4/1986','Nu','Tay Ninh','K13')
INSERT INTO HOCVIEN VALUES ('K1311','Tran Minh','Thuc','4/4/1986','Nam','TpHCM','K13')
INSERT INTO HOCVIEN VALUES ('K1312','Nguyen Thi Kim','Yen','7/9/1986','Nu','TpHCM','K13')

ALTER TABLE KHOA
CHECK CONSTRAINT FK_TRUONGKHOA;

ALTER TABLE LOP
CHECK CONSTRAINT FR_LOP_GV, FR_LOP_HV;

ALTER TABLE MONHOC
CHECK CONSTRAINT FK_MH_KHOA;

ALTER TABLE GIANGDAY
CHECK CONSTRAINT FK_GD_GV, FK_GD_LOP, FK_GD_MH;

ALTER TABLE GIAOVIEN
CHECK CONSTRAINT FK_GV_KHOA;

ALTER TABLE DIEUKIEN
CHECK CONSTRAINT FK_DK1, FK_DK2;

ALTER TABLE KETQUATHI
CHECK CONSTRAINT FK_KQT_HV, FK_KQT_MH;

ALTER TABLE HOCVIEN
CHECK CONSTRAINT FK_HV_LOP;

--Quan ly ban hang
/*2. Tao quan he SANPHAM1 chua toan bo du lieu cua quan he SANPHAM. Tao quan he KHACHHANG1 chua toan bo du lieu cua quan he KHACHHANG */

SELECT * INTO SANPHAM1 FROM SANPHAM

SELECT * INTO KHACHHANG1 FROM KHACHHANG

select * from SANPHAM1

/*3. Cap nhat gia tang 5% doi voi nhung san pham do "Thai Lan" san xuat (cho quan he SANPHAM1) */

UPDATE SANPHAM1
SET GIA = GIA * 1.05
WHERE (NUOCSX = 'Thai Lan')

/*4. Cap nhat gia giam 5% doi voi nhung san pham do "Trung Quoc" san xuat co gia tu 10000 tro xuong (cho quan he SANPHAM1) */

UPDATE SANPHAM1
SET GIA = GIA * 0.95
WHERE (NUOCSX = 'Trung Quoc' AND GIA <= 10000)

/*5. Cap nhat gia tri LOAIKH la "Vip" doi voi nhung khach hang dang ky thanh vien truoc ngay 1/1/2007 co doanh so tu 10.000.000 tro len hoac khac hang dang ky thanh vien tu 1/1/2007 tro ve sau co doanh so tu 2.000.000 tro len*/

UPDATE KHACHHANG1
SET LOAIKH = 'Vip'
WHERE ((NGDK < '1/1/2007' AND DOANHSO >= 10000000) OR (NGDK >= '1/1/2007' AND DOANHSO >= 2000000))

/*III
1. In ra danh sach cac san pham (MASP, TENSP) do "Trung Quoc" san xuat
*/

SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc';

/*2. In ra danh sach cac san pham (MASP, TENSP) co don vi tinh la "cay", "quyen"*/

SELECT MASP, TENSP
FROM SANPHAM
WHERE DVT IN ('cay','quyen');

/*3. In ra danh sach cac san pham (MASP, TENSP) co ma bat dau la "B" va ket thuc la "01"*/

SELECT MASP, TENSP
FROM SANPHAM
WHERE MASP LIKE 'B%01';

/*4. In ra danh sach cac san pham (MASP,TENSP) do "Trung Quoc" san xuat co gia tu 30000 den 40000*/

SELECT MASP, TENSP
FROM SANPHAM
WHERE (NUOCSX ='Trung Quoc' AND (GIA BETWEEN 30000 AND 40000))

/*5. In ra danh sach cac san pham (MASP,TENSP) do "Trung Quoc" hoac "Thai Lan" san xuat co gia tu 30000 den 40000 */

SELECT MASP, TENSP
FROM SANPHAM
WHERE (NUOCSX IN ('Trung Quoc', 'Thai Lan') AND (GIA BETWEEN 30000 AND 40000))

/*6. IN RA CAC SO HOA DON, TRI GIA HOA DON BAN RA TRONG NGAY 1/1/2007 VA NGAY 2/1/2007*/

SELECT SOHD, TRIGIA
FROM HOADON
WHERE NGHD IN ('1/1/2007','2/1/2007')

/*7. In ra cac so hoa don, tri gia hoa don trong thang 1/2007, sap xep theo ngay (tang dan) va tri gia cua hoa don (giam dan)*/

SELECT SOHD, TRIGIA
FROM HOADON
WHERE(MONTH(NGHD) = 1 AND YEAR(NGHD) = 2007)
ORDER BY NGHD ASC, TRIGIA DESC

/*8. In ra danh sach cac khach hang (MAKH,HOTEN) da mua hang trong 1/1/2007*/

SELECT KH.MAKH, HOTEN
FROM KHACHHANG KH
JOIN HOADON HD ON KH.MAKH = HD.MAKH 
WHERE NGHD = '1/1/2007'

/*9. In ra so hoa don, tri gia cac hoa don do nhan vien co ten "Nguyen Van B" lap trong ngay 28/10/2006*/

SELECT SOHD, TRIGIA
FROM HOADON HD
JOIN NHANVIEN NV ON HD.MANV = NV.MANV
WHERE HOTEN = 'Nguyen Van B' AND HD.NGHD = '28/10/2006'

/*10. In ra danh sach cac san pham (MASP, TENSP) duoc khach hang co ten "Nguyen Van A" mua trong thang 10/2006*/

SELECT SP.MASP, SP.TENSP
FROM KHACHHANG KH
JOIN HOADON HD ON KH.MAKH = HD.MAKH
JOIN CTHD CT ON HD.SOHD = CT.SOHD
JOIN SANPHAM SP ON CT.MASP = SP.MASP
WHERE (HOTEN = 'Nguyen Van A' AND MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006);

/*11. Tim cac so hoa don da mua san pham co ma so "BB01" hoac "BB02" */

SELECT SOHD
FROM CTHD
WHERE MASP IN ('BB01','BB02');

--Quan ly giao vu
USE QUANLYGIAOVU
/*I
11. Hoc vien it nhat 18 tuoi
*/

ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_TUOI CHECK (YEAR(GETDATE()) - YEAR(NGSINH) >= 18)

/*12. Giang day mot mon hoc ngay bat dau (TUNGAY) phai nho hon ngay ket thuc (DENNGAY) */

ALTER TABLE GIANGDAY
ADD CONSTRAINT CK_NGAY CHECK (TUNGAY < DENNGAY)

/*13. Giao vien khi vao lam it nhat la 22 tuoi*/

ALTER TABLE GIAOVIEN
ADD CONSTRAINT CK_TUOIGV CHECK (YEAR(GETDATE()) - YEAR(NGSINH) >= 22)

/*14. Tat ca cac mon hoc deu co so tin chi ly thuyet va tinh chi thuc hanh chen lech khong qua 3*/

ALTER TABLE MONHOC
ADD CONSTRAINT CK_2TC CHECK (ABS(TCLT - TCTH) <= 3)

/*III
	1. In ra danh sach (ma hoc vien, ho ten, ngay sinh, ma lop) lop truong cua lop
*/

SELECT MAHV, HO,TEN, NgSINH, HV.MALOP
FROM LOP
JOIN HOCVIEN HV ON LOP.TRGLOP = HV.MAHV

/*2. In ra bang diem khi thi (ma hoc vien, ho ten, lan thi, diem so) mon CTRR cua lop "K12", sap xep theo ten, ho hoc vien*/

SELECT DISTINCT HV.MAHV, HO, TEN, LANTHI, DIEM
FROM KETQUATHI KQT
JOIN HOCVIEN HV ON KQT.MAHV = HV.MAHV
WHERE MAMH = 'CTRR' AND MALOP = 'K12'
ORDER BY HV.TEN, HV.HO

/*3. In ra danh sach nhung hoc vien (mahv, ho ten) va nhung mon hoc ma hoc vien do thi lan thu nhat dat*/

SELECT DISTINCT HV.MAHV, HV.HO, HV.TEN, MH.MAMH, MH.TENMH
FROM KETQUATHI KQT
JOIN HOCVIEN HV ON KQT.MAHV = HV.MAHV
JOIN MONHOC MH ON KQT.MAMH = MH.MAMH
WHERE KQT.KQUA = 'DAT' AND LANTHI = 1

/*4. In ra danh sach nhung hoc vien (mahv, ho ten) cua lop "K11" thi mon CTRR khong dat (o lan thi 1)*/
SELECT DISTINCT HV.MAHV, HV.HO, HV.TEN
FROM KETQUATHI KQT
JOIN HOCVIEN HV ON KQT.MAHV = HV.MAHV
WHERE MAMH = 'CTRR' 
AND MALOP = 'K11'
AND LANTHI = 1
AND KQUA = 'KHONG DAT'

/*5. Danh sach hoc vien (mahv, ho ten) cua lop "K" thi mon CTRR khong dat (o tat ca cac lan thi)*/

SELECT DISTINCT HV.MAHV, HV.HO, HV.TEN
FROM KETQUATHI KQT
JOIN HOCVIEN HV ON KQT.MAHV = HV.MAHV
WHERE MAMH = 'CTRR' 
AND MALOP LIKE 'K%' 
AND KQUA = 'KHONG DAT'
/*--------Buoi 3--------*/
--Bai tap 1
-- 12.	Tìm các số hóa đơn đã mua sản phẩm có mã số “BB01” hoặc “BB02”, mỗi sản phẩm mua với số lượng từ 10 đến 20.
SELECT DISTINCT SOHD
FROM CTHD
WHERE (MASP IN ('BB01', 'BB02')) AND SL BETWEEN 10 AND 20

-- 13.	Tìm các số hóa đơn mua cùng lúc 2 sản phẩm có mã số “BB01” và “BB02”, mỗi sản phẩm mua với số lượng từ 10 đến 20.
SELECT SOHD FROM CTHD 
WHERE MASP IN ('BB01', 'BB02') AND SL BETWEEN 10 AND 20
GROUP BY SOHD 
HAVING COUNT(DISTINCT MASP) = 2

-- 14.	In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” sản xuất hoặc các sản phẩm được bán ra trong ngày 1/1/2007.
SELECT MASP, TENSP
FROM SANPHAM 
WHERE NUOCSX = 'Trung Quoc' OR MASP IN (
	SELECT DISTINCT CT.MASP 
	FROM CTHD CT INNER JOIN HOADON HD
	ON CT.SOHD = HD.SOHD
	WHERE NGHD = '01/01/2007')

-- 15.	In ra danh sách các sản phẩm (MASP,TENSP) không bán được.
SELECT MASP, TENSP
FROM SANPHAM 
WHERE MASP NOT IN (
	SELECT DISTINCT MASP 
	FROM CTHD)

-- 16.	In ra danh sách các sản phẩm (MASP,TENSP) không bán được trong năm 2006.
SELECT MASP, TENSP
FROM SANPHAM 
WHERE MASP NOT IN (
	SELECT CT.MASP
	FROM CTHD CT INNER JOIN HOADON HD
	ON CT.SOHD = HD.SOHD
	WHERE YEAR(NGHD) = 2006)
-- 17.	In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” sản xuất không bán được trong năm 2006.
SELECT MASP, TENSP
FROM SANPHAM 
WHERE NUOCSX = 'Trung Quoc' AND MASP NOT IN (
	SELECT DISTINCT CT.MASP
	FROM CTHD CT INNER JOIN HOADON HD
	ON CT.SOHD = HD.SOHD
	WHERE YEAR(NGHD) = 2006)

-- 18.	Tìm số hóa đơn đã mua tất cả các sản phẩm do Singapore sản xuất.
SELECT CT.SOHD
FROM CTHD CT INNER JOIN SANPHAM SP
ON CT.MASP = SP.MASP
WHERE NUOCSX = 'Singapore'
GROUP BY CT.SOHD 
HAVING COUNT(DISTINCT CT.MASP) = (
	SELECT COUNT(MASP) 
	FROM SANPHAM 
	WHERE NUOCSX = 'Singapore')

	--QUANLYGIAOVU

	-- II. Ngôn ngữ thao tác dữ liệu (Data Manipulation Language):
-- 1.	Tăng hệ số lương thêm 0.2 cho những giáo viên là trưởng khoa.
UPDATE GIAOVIEN 
SET HESO += HESO * 0.02 
WHERE MAGV IN (
	SELECT TRGKHOA FROM KHOA
)


/* 2.	Cập nhật giá trị điểm trung bình tất cả các môn học (DIEMTB) của mỗi học viên 
(tất cả các môn học đều có hệ số 1 và nếu học viên thi một môn nhiều lần, chỉ lấy điểm của lần thi sau cùng). */

ALTER TABLE HOCVIEN
ADD DIEMTB FLOAT;

UPDATE HOCVIEN 
SET DIEMTB = DTB_HOCVIEN.DTB
FROM HOCVIEN HV LEFT JOIN (
	SELECT MAHV, AVG(DIEM) AS DTB 
	FROM KETQUATHI A
	WHERE NOT EXISTS (
		SELECT 1 
		FROM KETQUATHI B 
		WHERE A.MAHV = B.MAHV AND A.MAMH = B.MAMH AND A.LANTHI < B.LANTHI
	) 
	GROUP BY MAHV
) DTB_HOCVIEN
ON HV.MAHV = DTB_HOCVIEN.MAHV

ALTER TABLE HOCVIEN
ADD GHICHU NVARCHAR(255),
    XEPLOAI NVARCHAR(50);


-- 3.	Cập nhật giá trị cho cột GHICHU là “Cam thi” đối với trường hợp: học viên có một môn bất kỳ thi lần thứ 3 dưới 5 điểm.
UPDATE HOCVIEN 
SET GHICHU = 'Cam thi'
WHERE MAHV IN (
	SELECT MAHV 
	FROM KETQUATHI 
	WHERE LANTHI = 3 AND DIEM < 5
)

/* 4.	Cập nhật giá trị cho cột XEPLOAI trong quan hệ HOCVIEN như sau:
		o	Nếu DIEMTB >= 9 thì XEPLOAI =”XS”
		o	Nếu  8 <= DIEMTB < 9 thì XEPLOAI = “G”
		o	Nếu  6.5 <= DIEMTB < 8 thì XEPLOAI = “K”
		o	Nếu  5  <= DIEMTB < 6.5 thì XEPLOAI = “TB”
		o	Nếu  DIEMTB < 5 thì XEPLOAI = ”Y”
*/
UPDATE HOCVIEN SET XEPLOAI = CASE 
	WHEN DIEMTB >= 9 THEN 'XS'
	WHEN DIEMTB >= 8 THEN 'G'
	WHEN DIEMTB >= 6.5 THEN 'K'
	WHEN DIEMTB >= 5 THEN 'TB'
	ELSE 'Y'
END


-- III. Ngôn ngữ truy vấn dữ liệu:
-- 6.	Tìm tên những môn học mà giáo viên có tên “Tran Tam Thanh” dạy trong học kỳ 1 năm 2006.

SELECT MAMH, TENMH FROM MONHOC
WHERE MAMH IN (
	SELECT DISTINCT MAMH 
	FROM GIANGDAY GD INNER JOIN GIAOVIEN GV 
	ON GD.MAGV = GV.MAGV 
	WHERE HOTEN = 'Tran Tam Thanh' AND HOCKY = 1 AND NAM = 2006
)


-- 7.	Tìm những môn học (mã môn học, tên môn học) mà giáo viên chủ nhiệm lớp “K11” dạy trong học kỳ 1 năm 2006.
SELECT MAMH, TENMH FROM MONHOC
WHERE MAMH IN (
	SELECT DISTINCT MAMH FROM GIANGDAY WHERE MAGV IN (
		SELECT MAGVCN FROM LOP WHERE MALOP = 'K11'
	) AND HOCKY = 1 AND NAM = 2006
)
GO

-- 8.	Tìm họ tên lớp trưởng của các lớp mà giáo viên có tên “Nguyen To Lan” dạy môn “Co So Du Lieu”.
SELECT HO + ' ' + TEN AS HOTEN FROM HOCVIEN
WHERE MAHV IN (
	SELECT TRGLOP FROM LOP 
	WHERE MALOP IN (
		SELECT DISTINCT MALOP FROM GIANGDAY 
		WHERE MAGV IN (
			SELECT MAGV FROM GIAOVIEN WHERE HOTEN = 'Nguyen To Lan'
		) AND MAMH IN (
			SELECT MAMH FROM MONHOC WHERE TENMH = 'Co So Du Lieu'
		)
	)
)


-- 9.	In ra danh sách những môn học (mã môn học, tên môn học) phải học liền trước môn “Co So Du Lieu”.
SELECT MAMH, TENMH FROM MONHOC
WHERE MAMH IN (
	SELECT MAMH_TRUOC FROM DIEUKIEN WHERE MAMH IN (
		SELECT MAMH FROM MONHOC WHERE TENMH = 'Co So Du Lieu'
	)
)


-- 10.	Môn “Cau Truc Roi Rac” là môn bắt buộc phải học liền trước những môn học (mã môn học, tên môn học) nào.
SELECT MAMH, TENMH FROM MONHOC
WHERE MAMH IN (
	SELECT MAMH FROM DIEUKIEN WHERE MAMH_TRUOC IN (
		SELECT MAMH FROM MONHOC WHERE TENMH = 'Cau Truc Roi Rac'
	)
)


-- 11.	Tìm họ tên giáo viên dạy môn CTRR cho cả hai lớp “K11” và “K12” trong cùng học kỳ 1 năm 2006.
SELECT HOTEN FROM GIAOVIEN 
WHERE MAGV IN (
	SELECT MAGV FROM GIANGDAY 
	WHERE MAMH = 'CTRR' AND MALOP IN ('K11', 'K12') AND HOCKY = 1 AND NAM = 2006
	GROUP BY MAGV 
	HAVING COUNT(DISTINCT MALOP) = 2
)


-- 12.	Tìm những học viên (mã học viên, họ tên) thi không đạt môn CSDL ở lần thi thứ 1 nhưng chưa thi lại môn này.
SELECT MAHV, HO + ' ' + TEN AS HOTEN FROM HOCVIEN 
WHERE MAHV IN (
	SELECT MAHV FROM KETQUATHI A
	WHERE NOT EXISTS (
		SELECT 1 FROM KETQUATHI B 
		WHERE A.MAHV = B.MAHV AND A.MAMH = B.MAMH AND A.LANTHI < B.LANTHI
	) AND MAMH = 'CSDL' AND LANTHI = 1 AND KQUA = 'Khong Dat'
)


-- 13.	Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào.
SELECT MAGV, HOTEN FROM GIAOVIEN 
WHERE MAGV NOT IN (
	SELECT DISTINCT MAGV FROM GIANGDAY
)


-- 14.	Tìm giáo viên (mã giáo viên, họ tên) không được phân công giảng dạy bất kỳ môn học nào thuộc khoa giáo viên đó phụ trách.
SELECT MAGV, HOTEN FROM GIAOVIEN 
WHERE MAGV NOT IN (
	SELECT GD.MAGV
	FROM GIANGDAY GD INNER JOIN GIAOVIEN GV 
	ON GD.MAGV = GV.MAGV INNER JOIN MONHOC MH
	ON GD.MAMH = MH.MAMH
	WHERE GV.MAKHOA = MH.MAKHOA
)


-- 15.	Tìm họ tên các học viên thuộc lớp “K11” thi một môn bất kỳ quá 3 lần vẫn “Khong dat” hoặc thi lần thứ 2 môn CTRR được 5 điểm.
SELECT HO + ' ' + TEN AS HOTEN FROM HOCVIEN
WHERE MAHV IN (
	SELECT MAHV FROM KETQUATHI A
	WHERE LEFT(MAHV, 3) = 'K11' AND ((
		NOT EXISTS (
			SELECT 1 FROM KETQUATHI B 
			WHERE A.MAHV = B.MAHV AND A.MAMH = B.MAMH AND A.LANTHI < B.LANTHI
		)  AND LANTHI = 3 AND KQUA = 'Khong Dat'
	) OR MAMH = 'CTRR' AND LANTHI = 2 AND DIEM = 5)
)


-- 16.	Tìm họ tên giáo viên dạy môn CTRR cho ít nhất hai lớp trong cùng một học kỳ của một năm học.
SELECT HOTEN FROM GIAOVIEN 
WHERE MAGV IN (
	SELECT MAGV FROM GIANGDAY 
	WHERE MAMH = 'CTRR'
	GROUP BY MAGV, HOCKY, NAM 
	HAVING COUNT(MALOP) >= 2
)


-- 17.	Danh sách học viên và điểm thi môn CSDL (chỉ lấy điểm của lần thi sau cùng).
SELECT HV.MAHV, HO + ' ' + TEN AS HOTEN, DIEM 
FROM HOCVIEN HV INNER JOIN (
	SELECT MAHV, DIEM 
	FROM KETQUATHI A
	WHERE NOT EXISTS (
		SELECT 1 
		FROM KETQUATHI B 
		WHERE A.MAHV = B.MAHV AND A.MAMH = B.MAMH AND A.LANTHI < B.LANTHI
	) AND MAMH = 'CSDL'
) DIEM_CSDL
ON HV.MAHV = DIEM_CSDL.MAHV


-- 18.	Danh sách học viên và điểm thi môn “Co So Du Lieu” (chỉ lấy điểm cao nhất của các lần thi).
SELECT HV.MAHV, HO + ' ' + TEN AS HOTEN, DIEM 
FROM HOCVIEN HV INNER JOIN (
	SELECT MAHV, MAX(DIEM) AS DIEM FROM KETQUATHI 
	WHERE MAMH IN (
		SELECT MAMH FROM MONHOC 
		WHERE TENMH = 'Co So Du Lieu'
	) 
	GROUP BY MAHV, MAMH
) DIEM_CSDL_MAX
ON HV.MAHV = DIEM_CSDL_MAX.MAHV
